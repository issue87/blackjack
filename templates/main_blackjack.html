<!DOCTYPE HTML>
<html>
    <head> <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">

<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css" integrity="sha512-dTfge/zgoMYpP7QbHy4gWMEGsbsdZeCXz7irItjcC3sPUFtf0kuFbDz/ixG7ArTxmDjLXDmezHubeNikyKGVyQ==" crossorigin="anonymous">
       <title> The game</title>
       <style>
          .button_style{width:80px;
                       height:50px;
                       border-radius:10px;
          }

          .button_d {
              float:left;
          }
          .par_d {
              font-family: 'Impact';
              font-size: 24pt;
          }
          .pos_center {
              display:inline-block;
              position:relative;
              left:250px;
          }
          #info_panel{
              position:relative;
              top:14px;
          }



       </style>

        <script type="text/javascript" src="https://gc.kis.v2.scr.kaspersky-labs.com/0D6F8B7E-9EFD-394F-A7B9-3CFFA041442C/main.js" charset="UTF-8"></script><script>
        CardValues = {0:2,1:3,2:4,3:5,4:6,5:7,6:8,7:9,8:10,9:10,10:10,11:10,12:11};
        function RandomSort(a,b){
                                     return (Math.random() - 0.5);
                                 };
        function Desk(number_of_cards){
           this.cards = [];
           var counter = 0;
           while (counter < 13){
              var counter_suits = 0;
              while (counter_suits < 4){
                  this.cards.push(new Card(counter,counter_suits,0));
                  counter_suits +=1;
              };
              if (number_of_cards == 36 && counter == 0){
                   counter += 5;
              }else{
                   counter += 1;
                };
              };
           this.cards.sort(RandomSort);
           this.takeCard = function(){
               return this.cards.pop();
           };
           this.takeCard = function(){
               return this.cards.pop();
           };
           this.getCards = function(){
               return this.cards;
           };
           this.getFirstCard = function(){
               return this.cards[0];
           };
           this.getLenCards = function(){
               return this.cards.length;
           };
        };

        function Card(rang,suit,value)
             {
                this.rang = rang;
                this.suit = suit;
                this.value = value;
                this.getValue = function()
                     {
                         return this.value;
                     };
                this.getRang = function()
                     {
                         return this.rang;
                     };
                this.setValue = function(value)
                     {
                         this.value = value;
                     };
                this.getSuit = function()
                     {
                        return this.suit;
                     };
             };
        function Hand()
        {
             this.cards = [];
             this.giveCard = function(card){
                 this.cards.push(card);
             };
             this.clearHand = function(){
                 this.cards = [];
             };
             this.getLength = function(){
                 return this.cards.length;
             };
             this.getCardsInHand = function(){
                 return this.cards;
             };
             this.getValuesOfHand = function(){
                 var value =0;
                 for (card in this.cards){
                      value += this.cards[card].getValue();
                 };
                 return value;
             };
        };
        function  getCardToHand(hand,desk){
               var card = desk.takeCard();
               var value = CardValues[card.getRang()];
               if (value == 11 && hand.getValuesOfHand()>10){
                     card.setValue(1);
               }else{
                     card.setValue(value);
                     hand.giveCard(card);
               };
        };


        function initGame(){
            var roundIsOngoing = false;
            var busted = false;
            var GameDesk,GameStarted;
            var buttonDeal = document.getElementById("b_deal");
            var buttonHit = document.getElementById("b_hit");
            var buttonStand = document.getElementById("b_stand");
            var PlayerHand = new Hand();
            var DealerHand = new Hand();
            function resultOfRound(playerLose)
            {
                     roundIsOngoing =false;
                     buttonDeal.style.backgroundColor = "";
                     buttonHit.style.backgroundColor = "gray";
                     buttonStand.style.backgroundColor = "gray";
                     if (playerLose || (!(DealerHand.getValuesOfHand()>21) && DealerHand.getValuesOfHand()>=PlayerHand.getValuesOfHand()))
                     {
                                /*games_session[session['username']].record_result(False)
                                record_n = db.session.query(UserData).filter(UserData.login==session['username'])[0]
                                record_n.loses += 1
                                db.session.commit()*/
                                console.log("player: "+PlayerHand.getValuesOfHand() + "; dealer: " +  DealerHand.getValuesOfHand() + " Dealer wins!");
                      }else
                      {
                                /*games_session[session['username']].record_result(True)
                                record_n = db.session.query(UserData).filter(UserData.login==session['username'])[0]
                                record_n.wines += 1
                                db.session.commit()
                                games_session[session['username']].set_round_is_ongoing(False)*/
                                console.log("player: "+PlayerHand.getValuesOfHand() + "; dealer: " +  DealerHand.getValuesOfHand() + " Player wins!");
                      };
            };
            function deal()
            {

                if (!roundIsOngoing)
                {
                     GameDesk = new Desk(52);
                     PlayerHand = new Hand();
                     DealerHand = new Hand();
                     GameStarted = true;
                     getCardToHand(PlayerHand,GameDesk);
                     getCardToHand(PlayerHand,GameDesk);
                     getCardToHand(DealerHand,GameDesk);
                     getCardToHand(DealerHand,GameDesk);
                     roundIsOngoing = true;
                     busted = false;
                     buttonDeal.style.backgroundColor = "gray";
                     buttonHit.style.backgroundColor = "";
                     buttonStand.style.backgroundColor = "";
                };
            };
            function stand()
            {
               if (roundIsOngoing)
               {
                        while (DealerHand.getValuesOfHand() < 17)
                        {
                            getCardToHand(DealerHand,GameDesk);
                        };
                        resultOfRound(false);
               };
            };
            function hit()
            {
                 if (roundIsOngoing)
                 {
                       getCardToHand(PlayerHand,GameDesk)
                       if (PlayerHand.getValuesOfHand()>21){
                           busted = true;
                           resultOfRound(true);
                       };

                 };
            };
            buttonDeal.addEventListener("click",deal);
            buttonHit.addEventListener("click",hit);
            buttonStand.addEventListener("click",stand);
            function canvasAnimation()
            {
                 var tileWidth = 144;
                 var tileHeigth = 201;
                 var drawingCanvas = document.getElementById('smile');
                 var tableImage = document.createElement('img');
                 tableImage.src ="/static/XRENDER2.png";
                 tableImage.onload = function(){
                     drawingCanvas.setAttribute('width',tableImage.width/3);
                     drawingCanvas.setAttribute('height',tableImage.height/3);
                     if(drawingCanvas && drawingCanvas.getContext) {
                         var context = drawingCanvas.getContext('2d');
                         context.drawImage(tableImage,0,0,tableImage.width,tableImage.height,0,0,tableImage.width/3,tableImage.height/3)
                         var image1 = document.createElement("img");
                         image1.src = "/static/Small_Cards.png";
                         var backImage = document.createElement("img");
                         backImage.src = "/static/back.jpg";

                         image1.onload = function() {

                             var counter = 0;
                             var cards = PlayerHand.getCardsInHand();
                             var playerHandX = 410 - Math.floor(cards.length/2)*tileWidth*0.1;
                             for ( i = 0;i<cards.length;i++)
                             {
                                  context.setTransform(1,0,0,1,0,0);
                                  var rad_angle;
                                  if ((cards.length-1)/2 == i)
                                  {
                                      rad_angle =0;
                                  }
                                  else if(Math.round(i/cards.length)==0)
                                  {
                                      rad_angle = -5*(Math.floor(cards.length/2)-i);
                                  }
                                  else
                                  {
                                      rad_angle = 5*(i-Math.ceil(cards.length/2)+1);
                                  };
                                  context.translate(playerHandX+i*tileWidth*0.1 + 0.5*(tileWidth/3),240+ 0.5*(tileHeigth/3));
                                  context.rotate(Math.ceil(cards.length/2)*rad_angle*(Math.PI/180));
                                  context.drawImage(image1,57+(tileWidth+11)*(cards[i].getRang()%7),258+ ((tileHeigth+16)*2+36)*cards[i].getSuit()+Math.floor(cards[i].getRang()/7)*(tileHeigth+16),tileWidth,tileHeigth,-0.5*tileWidth/3,-0.5*tileHeigth/3,tileWidth/3,tileHeigth/3);
                             };
                             context.setTransform(1,0,0,1,0,0);
                             counter = 0;
                             cards = DealerHand.getCardsInHand();;
                              if(roundIsOngoing){
                                context.drawImage(image1,57+(tileWidth+11)*6, 258+tileHeigth+16,tileWidth,tileHeigth,410 - Math.ceil(cards.length/2)*tileWidth*0.1,70,tileWidth/3,tileHeigth/3);
                             };
                             for ( i = 0;i<cards.length;i++)
                             {
                                  if (!(i==0&&roundIsOngoing)){
                                       context.drawImage(image1,57+(tileWidth+11)*(cards[i].getRang()%7),258+ ((tileHeigth+16)*2+36)*cards[i].getSuit()+Math.floor(cards[i].getRang()/7)*(tileHeigth+16),tileWidth,tileHeigth,410- Math.ceil(cards.length/2)*tileWidth*0.1+i*tileWidth*0.1,70,tileWidth/3,tileHeigth/3);
                                  };
                             };

                        };
                    };
                };
                window.setTimeout(canvasAnimation,300);
            };
            canvasAnimation();

        };
   window.onload = function() {

        initGame();
       };
  </script>
    </head>
    <body>
        <div  class="button_d" >
             User: {{login}}
        </div>
        {% if not vk %}
        <div>
            <form action ="/logout" method=GET>
                 <button class = "button_style" type="submit">
                       Logout
                 </button>

            </form>
        </div>
        {% else %}
        <div>
            <form action ="/vk" method=GET>
                 <button class = "button_style" type="submit">
                       Back
                 </button>

            </form>
        </div>
        {% endif %}
       <div>
             <canvas id="smile" width="200" height="200" border = 5>“Your browser does not support HTML5 Canvas.”</canvas>
       </div>
       <div id="button_hit" class ="pos_center">
                   <button id = "b_hit" class = "button_style"
                      type="button" value="Hit">
                       Hit
                    </button>
       </div>
<div id="button_stand" class="pos_center">
                <button id = "b_stand" class = "button_style" type="button" value="Stand">
                    Stand
                </button>
</div>
<div id="button_deal" class="pos_center">
                <button id ="b_deal" class = "button_style" type="button" value="Deal">
                    Deal
                </button>
</div>



    </body>
</html>